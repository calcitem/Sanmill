#!/usr/bin/env bash

# Sanmill Pre-commit Hook (Maintenance Phase)
# Simple validation for code quality

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[PRE-COMMIT]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[PRE-COMMIT]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[PRE-COMMIT]${NC} $1"
}

log_error() {
    echo -e "${RED}[PRE-COMMIT]${NC} $1"
}

log_info "Running pre-commit validation..."

# Check if format.sh exists and run it
if [[ -f "format.sh" ]]; then
    log_info "Running code formatting check..."
    if ./format.sh s; then
        log_success "Code formatting check passed"
    else
        log_error "Code formatting failed - please run ./format.sh s"
        exit 1
    fi
else
    log_warning "format.sh not found, skipping formatting check"
fi

# Check for basic syntax errors in staged files
STAGED_FILES=$(git diff --cached --name-only)
VALIDATION_FAILED=false

for file in $STAGED_FILES; do
    case "$file" in
        *.cpp|*.h)
            # Basic C++ syntax check (if compiler available)
            if command -v g++ >/dev/null 2>&1; then
                if ! g++ -fsyntax-only "$file" 2>/dev/null; then
                    log_error "C++ syntax error in: $file"
                    VALIDATION_FAILED=true
                fi
            fi
            ;;
        *.dart)
            # Basic Dart syntax check (if dart available)
            if command -v dart >/dev/null 2>&1; then
                if ! dart analyze "$file" 2>/dev/null; then
                    log_warning "Dart analysis issues in: $file (not blocking)"
                fi
            fi
            ;;
        *.json)
            # JSON validation
            if command -v python >/dev/null 2>&1; then
                if ! python -m json.tool "$file" >/dev/null 2>&1; then
                    log_error "Invalid JSON format: $file"
                    VALIDATION_FAILED=true
                fi
            fi
            ;;
    esac
done

# Final result
if [[ "$VALIDATION_FAILED" == "true" ]]; then
    log_error "Pre-commit validation failed!"
    log_error "Please fix the issues above before committing."
    exit 1
else
    log_success "Pre-commit validation completed successfully!"
fi

exit 0